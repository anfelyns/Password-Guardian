import mysql.connector
from mysql.connector import Error

def test_mysql_passwords():
    print("üîç Test des mots de passe MySQL XAMPP (port 1234)...")
    
    # Tous les mots de passe courants de XAMPP
    passwords_to_try = [
        '',            # Vide
        'root',        # Tr√®s courant
        'password',    # Anglais
        '1234',        # Simple
        'admin',       # Parfois utilis√©
    ]
    
    for password in passwords_to_try:
        try:
            print(f"üîß Essai avec mot de passe: '{password}'")
            
            config = {
                'host': 'localhost',
                'user': 'root',
                'password': password,
                'database': 'password_guardian',
                'port': 1234,  # ‚¨ÖÔ∏è PORT CORRECT
                'charset': 'utf8mb4'
            }
            
            conn = mysql.connector.connect(**config)
            
            print(f"üéâ SUCC√àS ! Mot de passe trouv√©: '{password}'")
            
            # V√©rifier les tables
            cursor = conn.cursor()
            cursor.execute("SHOW TABLES")
            tables = cursor.fetchall()
            
            print(f"üìä Tables trouv√©es : {len(tables)}")
            for table in tables:
                print(f"   - {table[0]}")
            
            cursor.close()
            conn.close()
            
            # Mettre √† jour database_manager.py
            update_database_manager(password)
            return True
            
        except Error as e:
            error_msg = str(e)
            if "1045" in error_msg:
                print(f"‚ùå Acc√®s refus√© avec '{password}'")
            else:
                print(f"‚ùå Autre erreur avec '{password}': {error_msg}")
    
    print("\nüí° Solution : R√©initialiser le mot de passe")
    print("1. Arr√™te MySQL dans XAMPP")
    print("2. Clique sur 'Shell'")
    print("3. Ex√©cute: mysqladmin -u root password \"newpassword\"")
    return False

def update_database_manager(password):
    """Mettre √† jour le fichier database_manager.py avec le bon port et mot de passe"""
    try:
        with open('src/database/database_manager.py', 'r', encoding='utf-8') as file:
            content = file.read()
        
        # Remplacer le mot de passe ET ajouter le port
        new_content = content.replace(
            "password='password123'", 
            f"password='{password}', port=1234"
        )
        
        with open('src/database/database_manager.py', 'w', encoding='utf-8') as file:
            file.write(new_content)
        
        print(f"‚úÖ DatabaseManager mis √† jour : port=1234, password='{password}'")
        
    except Exception as e:
        print(f"‚ùå Erreur mise √† jour: {e}")

if __name__ == "__main__":
    test_mysql_passwords()